# MOBIUS-CLASS: catalog-integrity
# OWNER: @kaizencycle
# INTRODUCED: C-150
# LAST-REVIEWED: 2026-01-05
# STATUS: active
# PURPOSE: Ensures catalog/mobius_catalog.json stays in sync with EPICONs and docs
#
# This is the "archivist at the door" â€” you can rearrange the library all you want,
# but you must update the catalog before you leave.

name: Mobius Catalog Integrity Check

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop

jobs:
  catalog-check:
    name: Check Catalog Freshness
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Regenerate Mobius catalog
        run: npm run export:catalog
        env:
          GIT_COMMIT: ${{ github.sha }}

      - name: Check for catalog drift
        run: |
          if git diff --quiet --exit-code catalog/mobius_catalog.json; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  âœ… CATALOG IS UP TO DATE                                    â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
          else
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  âŒ CATALOG IS OUT OF DATE                                   â•‘"
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘                                                              â•‘"
            echo "â•‘  The catalog/mobius_catalog.json file has drifted.           â•‘"
            echo "â•‘                                                              â•‘"
            echo "â•‘  To fix, run:                                                â•‘"
            echo "â•‘                                                              â•‘"
            echo "â•‘    npm run export:catalog                                    â•‘"
            echo "â•‘    git add catalog/mobius_catalog.json                       â•‘"
            echo "â•‘    git commit --amend --no-edit                              â•‘"
            echo "â•‘                                                              â•‘"
            echo "â•‘  Or simply:                                                  â•‘"
            echo "â•‘                                                              â•‘"
            echo "â•‘    npm run export:catalog && git add -A && git commit -m ... â•‘"
            echo "â•‘                                                              â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "Diff:"
            git diff -- catalog/mobius_catalog.json | head -100
            exit 1
          fi

      - name: Catalog Summary
        if: success()
        run: |
          echo "## ðŸ“š Mobius Catalog Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          EPICON_COUNT=$(node -e "console.log(JSON.parse(require('fs').readFileSync('catalog/mobius_catalog.json')).stats.epiconCount)")
          DOC_COUNT=$(node -e "console.log(JSON.parse(require('fs').readFileSync('catalog/mobius_catalog.json')).stats.docCount)")
          VERSION=$(node -e "console.log(JSON.parse(require('fs').readFileSync('catalog/mobius_catalog.json')).mobius_catalog_version)")
          
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Catalog Version | \`$VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| EPICONs | $EPICON_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs | $DOC_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… In Sync |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*\"We heal as we walk.\" â€” Mobius Systems*" >> $GITHUB_STEP_SUMMARY

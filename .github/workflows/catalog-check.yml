# MOBIUS-CLASS: catalog-integrity
# OWNER: @kaizencycle
# INTRODUCED: C-150
# LAST-REVIEWED: 2026-01-05
# STATUS: active
# PURPOSE: Ensures catalog/mobius_catalog.json stays in sync with EPICONs and docs
#
# This is the "archivist at the door" â€” you can rearrange the library all you want,
# but you must update the catalog before you leave.

name: Mobius Catalog Integrity Check

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop

jobs:
  catalog-check:
    name: Check Catalog Freshness
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Regenerate Mobius catalog
        run: npm run export:catalog
        env:
          GIT_COMMIT: ${{ github.sha }}

      - name: Check for catalog drift
        run: |
          # Compare catalogs ignoring volatile fields (generated_at, commit)
          # These fields change on every regeneration and should not cause drift failures
          
          # Extract the committed catalog (before regeneration)
          git show HEAD:catalog/mobius_catalog.json > /tmp/committed_catalog.json 2>/dev/null || echo '{}' > /tmp/committed_catalog.json
          
          # Create normalized versions without volatile fields
          node -e "
            const fs = require('fs');
            const normalize = (obj) => {
              const copy = JSON.parse(JSON.stringify(obj));
              delete copy.generated_at;
              if (copy.repo) delete copy.repo.commit;
              return copy;
            };
            
            const committed = JSON.parse(fs.readFileSync('/tmp/committed_catalog.json', 'utf8'));
            const regenerated = JSON.parse(fs.readFileSync('catalog/mobius_catalog.json', 'utf8'));
            
            const committedNorm = normalize(committed);
            const regeneratedNorm = normalize(regenerated);
            
            // Compare normalized versions
            const match = JSON.stringify(committedNorm) === JSON.stringify(regeneratedNorm);
            
            if (match) {
              console.log('CATALOG_STATUS=up_to_date');
            } else {
              console.log('CATALOG_STATUS=drifted');
              
              // Show what actually changed (excluding volatile fields)
              const findDiffs = (a, b, path = '') => {
                if (typeof a !== typeof b) return [path + ': type mismatch'];
                if (Array.isArray(a) && Array.isArray(b)) {
                  if (a.length !== b.length) return [path + ': array length ' + a.length + ' vs ' + b.length];
                  return a.flatMap((_, i) => findDiffs(a[i], b[i], path + '[' + i + ']'));
                }
                if (typeof a === 'object' && a !== null) {
                  const keys = new Set([...Object.keys(a), ...Object.keys(b)]);
                  return [...keys].flatMap(k => findDiffs(a[k], b[k], path ? path + '.' + k : k));
                }
                if (a !== b) return [path + ': ' + JSON.stringify(a) + ' â†’ ' + JSON.stringify(b)];
                return [];
              };
              
              const diffs = findDiffs(committedNorm, regeneratedNorm).slice(0, 20);
              if (diffs.length > 0) {
                console.log('DIFFS=' + JSON.stringify(diffs));
              }
            }
          " > /tmp/catalog_check_result.txt
          
          source /tmp/catalog_check_result.txt
          
          if [ "$CATALOG_STATUS" = "up_to_date" ]; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  âœ… CATALOG IS UP TO DATE                                    â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
          else
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  âŒ CATALOG IS OUT OF DATE                                   â•‘"
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘                                                              â•‘"
            echo "â•‘  The catalog/mobius_catalog.json file has drifted.           â•‘"
            echo "â•‘  (Ignoring volatile fields: generated_at, repo.commit)       â•‘"
            echo "â•‘                                                              â•‘"
            echo "â•‘  To fix, run:                                                â•‘"
            echo "â•‘                                                              â•‘"
            echo "â•‘    npm run export:catalog                                    â•‘"
            echo "â•‘    git add catalog/mobius_catalog.json                       â•‘"
            echo "â•‘    git commit --amend --no-edit                              â•‘"
            echo "â•‘                                                              â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "Meaningful changes detected:"
            echo "$DIFFS" | node -e "const d=require('fs').readFileSync(0,'utf8');try{JSON.parse(d).forEach(x=>console.log('  - '+x))}catch{console.log(d)}"
            exit 1
          fi

      - name: Catalog Summary
        if: success()
        run: |
          echo "## ðŸ“š Mobius Catalog Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          EPICON_COUNT=$(node -e "console.log(JSON.parse(require('fs').readFileSync('catalog/mobius_catalog.json')).stats.epiconCount)")
          DOC_COUNT=$(node -e "console.log(JSON.parse(require('fs').readFileSync('catalog/mobius_catalog.json')).stats.docCount)")
          VERSION=$(node -e "console.log(JSON.parse(require('fs').readFileSync('catalog/mobius_catalog.json')).mobius_catalog_version)")
          
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Catalog Version | \`$VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| EPICONs | $EPICON_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs | $DOC_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… In Sync |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*\"We heal as we walk.\" â€” Mobius Systems*" >> $GITHUB_STEP_SUMMARY

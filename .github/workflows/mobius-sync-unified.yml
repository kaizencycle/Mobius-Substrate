# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Mobius Sync (Unified)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Consolidates: kaizen-sync.yml, atlas-sync.yml, ping-atlas.yml
# EPICON Layer: EPICON-2 (Memory Matrix)
# Cycle: C-177
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Mobius Sync (Unified)

on:
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours
  push:
    branches: [main, develop]
    paths:
      - 'docs/lab*/**'
      - 'accords/registry/**'
      - 'kaizen_manifest.yaml'
  pull_request:
    types: [opened, synchronize, closed, reopened]
  release:
    types: [published, created]
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'Type of sync to perform'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - manifest
          - atlas

permissions:
  contents: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # KAIZEN MANIFEST SYNC
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  manifest-sync:
    name: ðŸ“‹ Kaizen Manifest Sync
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' || 
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && contains(github.event.head_commit.modified, 'kaizen_manifest.yaml'))
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema
          
      - name: Validate Kaizen Manifest
        if: ${{ hashFiles('scripts/validate_manifest.py') != '' }}
        run: python scripts/validate_manifest.py
          
      - name: Run Kaizen Sync
        run: |
          echo "## Kaizen OS Chamber Sync" >> $GITHUB_STEP_SUMMARY
          if [ -f "kaizen_manifest.yaml" ]; then
            echo "**System:** $(python -c "import yaml; print(yaml.safe_load(open('kaizen_manifest.yaml'))['meta']['system_name'])")" >> $GITHUB_STEP_SUMMARY
            echo "**Version:** $(python -c "import yaml; print(yaml.safe_load(open('kaizen_manifest.yaml'))['meta']['version'])")" >> $GITHUB_STEP_SUMMARY
          fi
          echo "**Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ATLAS SYNC NOTIFICATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  atlas-sync:
    name: ðŸ¤– ATLAS Sync
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get commit details
        id: commit_info
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=format:'%an' 2>/dev/null || echo 'unknown')" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=format:'%s' 2>/dev/null || echo 'No message')" >> $GITHUB_OUTPUT
          echo "files_changed=$(git diff --name-only HEAD^ HEAD 2>/dev/null | wc -l || echo '0')" >> $GITHUB_OUTPUT

      - name: Categorize changes
        id: categorize
        run: |
          INFRA_CHANGES=$(git diff --name-only HEAD^ HEAD 2>/dev/null | grep -E '(vercel\.json|\.github/|Dockerfile|render\.yaml|infra/)' | wc -l || echo '0')
          DOCS_CHANGES=$(git diff --name-only HEAD^ HEAD 2>/dev/null | grep -E '(README|docs/|\.md)' | wc -l || echo '0')
          APP_CHANGES=$(git diff --name-only HEAD^ HEAD 2>/dev/null | grep -E '(apps/|packages/|src/)' | wc -l || echo '0')

          echo "infra=$INFRA_CHANGES" >> $GITHUB_OUTPUT
          echo "docs=$DOCS_CHANGES" >> $GITHUB_OUTPUT
          echo "app=$APP_CHANGES" >> $GITHUB_OUTPUT

      - name: Notify ATLAS
        env:
          ATLAS_SYNC_URL: ${{ secrets.ATLAS_SYNC_URL }}
          ATLAS_SYNC_TOKEN: ${{ secrets.ATLAS_SYNC_TOKEN }}
          EVENT_TYPE: ${{ github.event_name }}
          REF: ${{ github.ref }}
          SHA: ${{ github.sha }}
        run: |
          echo "## ATLAS Sync Event" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Event | $EVENT_TYPE |" >> $GITHUB_STEP_SUMMARY
          echo "| Ref | $REF |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ steps.commit_info.outputs.sha_short }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Author | ${{ steps.commit_info.outputs.author }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Files Changed | ${{ steps.commit_info.outputs.files_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Change Breakdown" >> $GITHUB_STEP_SUMMARY
          echo "- Infrastructure: ${{ steps.categorize.outputs.infra }}" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation: ${{ steps.categorize.outputs.docs }}" >> $GITHUB_STEP_SUMMARY
          echo "- Application: ${{ steps.categorize.outputs.app }}" >> $GITHUB_STEP_SUMMARY
          
          # Send to ATLAS if configured
          if [ -n "$ATLAS_SYNC_URL" ] && [ -n "$ATLAS_SYNC_TOKEN" ]; then
            curl -sSf -X POST "$ATLAS_SYNC_URL/sync/post_repo_sync_ack" \
              -H "Authorization: Bearer $ATLAS_SYNC_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"repo\":\"${{ github.repository }}\",\"sha\":\"${{ github.sha }}\",\"event\":\"$EVENT_TYPE\"}" || true
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… ATLAS notified successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ ATLAS sync endpoint not configured" >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SUMMARY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  summary:
    name: ðŸ“‹ Sync Summary
    runs-on: ubuntu-latest
    needs: [manifest-sync, atlas-sync]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸ”„ Mobius Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Manifest Sync | ${{ needs.manifest-sync.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ATLAS Sync | ${{ needs.atlas-sync.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Mobius Sync (Unified) Â· EPICON-2*" >> $GITHUB_STEP_SUMMARY

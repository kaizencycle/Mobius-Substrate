name: attestation

on:
  push:
    tags: ["v*.*.*"]

permissions:
  contents: read
  id-token: write
  packages: write

jobs:
  attest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Generate SBOM
        run: |
          mkdir -p attestations
          echo "TODO: generate SBOM (syft/cdxgen) and checksums"
          echo '{"sbom":"placeholder"}' > attestations/sbom.json
      
      - name: Generate Release Attestation
        run: |
          cat > attestations/release.json <<EOF
          {
            "version": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "mii_gate": ">=0.95",
            "signed_by": "github-actions",
            "attestation_type": "release"
          }
          EOF
      
      - name: Cosign attest (placeholder)
        run: |
          echo "TODO: cosign attest --predicate ./attestations/release.json"
          echo "Requires Sigstore/Cosign setup with OIDC"
      
      - name: Upload attestation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: attestations-${{ github.ref_name }}
          path: attestations/

# MOBIUS-CLASS: core-integrity
# OWNER: @kaizencycle
# INTRODUCED: C-148
# LAST-REVIEWED: 2025-11-29
# STATUS: active

name: Cycle Attestation

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      cycle:
        description: 'Cycle number (e.g., C-148)'
        required: true
        type: string
      force_attest:
        description: 'Force attestation even if exists'
        required: false
        type: boolean
        default: false

env:
  LEDGER_API_URL: ${{ secrets.LEDGER_API_URL || 'http://localhost:4001' }}

jobs:
  attest-cycle:
    name: Attest Cycle to Civic Ledger
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for cycle analysis
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      # ============================================
      # Extract Cycle Information
      # ============================================
      
      - name: Extract cycle information
        id: cycle
        run: |
          echo "Extracting cycle information from commit..."
          
          # Get cycle from workflow input or commit message
          if [ -n "${{ github.event.inputs.cycle }}" ]; then
            CYCLE="${{ github.event.inputs.cycle }}"
          else
            # Extract from commit message
            CYCLE=$(git log -1 --pretty=%B | grep -oP 'C-\d+' | head -1)
          fi
          
          if [ -z "$CYCLE" ]; then
            echo "⚠️  No cycle number found in commit"
            echo "cycle_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "cycle_found=true" >> $GITHUB_OUTPUT
          echo "cycle=$CYCLE" >> $GITHUB_OUTPUT
          
          # Extract commit info
          COMMIT_SHA=$(git rev-parse HEAD)
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_EMAIL=$(git log -1 --pretty=%ae)
          COMMIT_TIME=$(git log -1 --pretty=%cI)
          
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit_short=$COMMIT_SHORT" >> $GITHUB_OUTPUT
          echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
          echo "commit_time=$COMMIT_TIME" >> $GITHUB_OUTPUT
          
          echo "✅ Cycle: $CYCLE"
          echo "✅ Commit: $COMMIT_SHORT"
          echo "✅ Author: $COMMIT_AUTHOR"
      
      # ============================================
      # Compute Change Statistics
      # ============================================
      
      - name: Compute change statistics
        id: stats
        if: steps.cycle.outputs.cycle_found == 'true'
        run: |
          echo "Computing change statistics..."
          
          # Get previous commit
          PREV_COMMIT=$(git rev-parse HEAD^)
          
          # Count changes
          FILES_ADDED=$(git diff --name-status $PREV_COMMIT HEAD | grep "^A" | wc -l)
          FILES_MODIFIED=$(git diff --name-status $PREV_COMMIT HEAD | grep "^M" | wc -l)
          FILES_DELETED=$(git diff --name-status $PREV_COMMIT HEAD | grep "^D" | wc -l)
          
          LINES_ADDED=$(git diff $PREV_COMMIT HEAD | grep "^+" | grep -v "^+++" | wc -l)
          LINES_REMOVED=$(git diff $PREV_COMMIT HEAD | grep "^-" | grep -v "^---" | wc -l)
          
          TOTAL_FILES=$((FILES_ADDED + FILES_MODIFIED + FILES_DELETED))
          NET_LINES=$((LINES_ADDED - LINES_REMOVED))
          
          echo "files_added=$FILES_ADDED" >> $GITHUB_OUTPUT
          echo "files_modified=$FILES_MODIFIED" >> $GITHUB_OUTPUT
          echo "files_deleted=$FILES_DELETED" >> $GITHUB_OUTPUT
          echo "lines_added=$LINES_ADDED" >> $GITHUB_OUTPUT
          echo "lines_removed=$LINES_REMOVED" >> $GITHUB_OUTPUT
          echo "total_files=$TOTAL_FILES" >> $GITHUB_OUTPUT
          echo "net_lines=$NET_LINES" >> $GITHUB_OUTPUT
          
          echo "Files: +$FILES_ADDED ~$FILES_MODIFIED -$FILES_DELETED"
          echo "Lines: +$LINES_ADDED -$LINES_REMOVED (net: $NET_LINES)"
      
      # ============================================
      # Compute Integrity Scores
      # ============================================
      
      - name: Compute integrity scores
        id: integrity
        if: steps.cycle.outputs.cycle_found == 'true'
        run: |
          echo "Computing integrity scores..."
          
          # Simple MII heuristic (replace with actual computation)
          MII_BASE=0.90
          
          # Bonuses
          if git diff --name-only HEAD^ HEAD | grep -q "\.test\.ts\|\.spec\.ts"; then
            MII_BASE=$(echo "$MII_BASE + 0.03" | bc)
            echo "✅ Tests included (+0.03)"
          fi
          
          if git diff --name-only HEAD^ HEAD | grep -q "\.md\|docs/"; then
            MII_BASE=$(echo "$MII_BASE + 0.02" | bc)
            echo "✅ Documentation updated (+0.02)"
          fi
          
          if git diff --name-only HEAD^ HEAD | grep -q "\.github/workflows"; then
            MII_BASE=$(echo "$MII_BASE + 0.02" | bc)
            echo "✅ Workflow improvements (+0.02)"
          fi
          
          # Penalties
          LINES_ADDED=${{ steps.stats.outputs.lines_added }}
          if [ "$LINES_ADDED" -gt 1000 ]; then
            MII_BASE=$(echo "$MII_BASE - 0.03" | bc)
            echo "⚠️  Large change (-0.03)"
          fi
          
          # Final scores (would come from actual MII computation)
          GI_SCORE=$MII_BASE
          ECHO_SCORE=$(echo "$MII_BASE + 0.01" | bc)  # Typically slightly higher
          MII_SCORE=$MII_BASE
          
          echo "gi_score=$GI_SCORE" >> $GITHUB_OUTPUT
          echo "echo_score=$ECHO_SCORE" >> $GITHUB_OUTPUT
          echo "mii_score=$MII_SCORE" >> $GITHUB_OUTPUT
          
          echo "GI Score: $GI_SCORE"
          echo "ECHO Score: $ECHO_SCORE"
          echo "MII Score: $MII_SCORE"
      
      # ============================================
      # Create Attestation
      # ============================================
      
      - name: Create ledger attestation
        id: attest
        if: steps.cycle.outputs.cycle_found == 'true'
        env:
          CYCLE: ${{ steps.cycle.outputs.cycle }}
          COMMIT_SHA: ${{ steps.cycle.outputs.commit_sha }}
          COMMIT_TIME: ${{ steps.cycle.outputs.commit_time }}
          COMMIT_AUTHOR: ${{ steps.cycle.outputs.commit_author }}
          GI_SCORE: ${{ steps.integrity.outputs.gi_score }}
          ECHO_SCORE: ${{ steps.integrity.outputs.echo_score }}
          MII_SCORE: ${{ steps.integrity.outputs.mii_score }}
        run: |
          echo "Creating attestation JSON..."
          
          # Create attestation payload
          cat > attestation.json << EOF
          {
            "cycle": "$CYCLE",
            "timestamp": "$COMMIT_TIME",
            "phase": "CYCLE_ATTEST",
            "commit": {
              "sha": "$COMMIT_SHA",
              "author": "$COMMIT_AUTHOR",
              "timestamp": "$COMMIT_TIME"
            },
            "integrity": {
              "gi_score": $GI_SCORE,
              "echo_score": $ECHO_SCORE,
              "mii_score": $MII_SCORE
            },
            "changes": {
              "files_added": ${{ steps.stats.outputs.files_added }},
              "files_modified": ${{ steps.stats.outputs.files_modified }},
              "files_deleted": ${{ steps.stats.outputs.files_deleted }},
              "lines_added": ${{ steps.stats.outputs.lines_added }},
              "lines_removed": ${{ steps.stats.outputs.lines_removed }}
            },
            "sentinels": {
              "atlas_approved": true,
              "aurea_approved": true,
              "echo_approved": true
            },
            "metadata": {
              "repository": "${{ github.repository }}",
              "workflow": "${{ github.workflow }}",
              "run_id": "${{ github.run_id }}"
            }
          }
          EOF
          
          echo "Attestation created:"
          cat attestation.json | jq .
          
          # Compute attestation hash
          HASH=$(cat attestation.json | sha256sum | awk '{print $1}')
          echo "attestation_hash=$HASH" >> $GITHUB_OUTPUT
          echo ""
          echo "✅ Attestation hash: $HASH"
      
      # ============================================
      # Write to Ledger
      # ============================================
      
      - name: Write attestation to ledger
        if: steps.cycle.outputs.cycle_found == 'true'
        env:
          CYCLE: ${{ steps.cycle.outputs.cycle }}
          ATTESTATION_HASH: ${{ steps.attest.outputs.attestation_hash }}
        run: |
          echo "Writing attestation to Civic Ledger..."
          
          # Create ledger directory if it doesn't exist
          mkdir -p ledger/cycles
          
          # Write attestation file
          cp attestation.json "ledger/cycles/$CYCLE.json"
          
          echo "✅ Attestation written to ledger/cycles/$CYCLE.json"
          
          # Also append to master ledger log
          mkdir -p ledger/guardian
          echo "$(date -Iseconds) | $CYCLE | $ATTESTATION_HASH" >> ledger/guardian/cycles.log
          
          echo "✅ Logged to guardian/cycles.log"
      
      # ============================================
      # Post to Ledger API (if available)
      # ============================================
      
      - name: Post to Ledger API
        if: steps.cycle.outputs.cycle_found == 'true' && env.LEDGER_API_URL != ''
        continue-on-error: true
        env:
          LEDGER_API_URL: ${{ env.LEDGER_API_URL }}
        run: |
          echo "Posting attestation to Ledger API..."
          
          # POST to ledger API
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d @attestation.json \
            "$LEDGER_API_URL/api/v1/attestations" \
            -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "✅ Posted to ledger API"
            echo "$BODY" | jq .
          else
            echo "⚠️  Ledger API unavailable (HTTP $HTTP_CODE)"
            echo "Attestation saved locally in ledger/"
          fi
      
      # ============================================
      # Commit Attestation
      # ============================================
      
      - name: Commit attestation to repository
        if: steps.cycle.outputs.cycle_found == 'true'
        env:
          CYCLE: ${{ steps.cycle.outputs.cycle }}
        run: |
          echo "Committing attestation to repository..."
          
          git config user.name "Mobius Guardian"
          git config user.email "guardian@mobius.systems"
          
          git add ledger/cycles/$CYCLE.json
          git add ledger/guardian/cycles.log
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ledger: attest $CYCLE to Civic Ledger

Attestation hash: ${{ steps.attest.outputs.attestation_hash }}
GI Score: ${{ steps.integrity.outputs.gi_score }}
ECHO Score: ${{ steps.integrity.outputs.echo_score }}

[skip ci]"
            
            git push
            
            echo "✅ Attestation committed and pushed"
          fi
      
      # ============================================
      # Summary
      # ============================================
      
      - name: Attestation summary
        if: steps.cycle.outputs.cycle_found == 'true'
        env:
          CYCLE: ${{ steps.cycle.outputs.cycle }}
          HASH: ${{ steps.attest.outputs.attestation_hash }}
          GI: ${{ steps.integrity.outputs.gi_score }}
          ECHO: ${{ steps.integrity.outputs.echo_score }}
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ CYCLE ATTESTATION COMPLETE"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "Cycle: $CYCLE"
          echo "Hash: $HASH"
          echo "GI Score: $GI"
          echo "ECHO Score: $ECHO"
          echo ""
          echo "Phase 4: CYCLE_ATTEST ✅ COMPLETE"
          echo ""
          echo "Attestation stored in:"
          echo "  - ledger/cycles/$CYCLE.json"
          echo "  - ledger/guardian/cycles.log"
          echo ""
          echo "The cycle is now immutably recorded."
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      
      # ============================================
      # Handle Non-Cycle Commits
      # ============================================
      
      - name: Non-cycle commit
        if: steps.cycle.outputs.cycle_found == 'false'
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "ℹ️  Non-cycle commit detected"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "This commit does not include a cycle number."
          echo "No attestation will be created."
          echo ""
          echo "For hotfixes and minor updates, this is normal."
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# .github/workflows/catalog-validation.yml
#
# Validates that the Mobius catalog is up-to-date with EPICON and docs changes.
# Fails if catalog/mobius_catalog.json is stale after regeneration.
#
# Triggers:
#   - Push/PR to main branch
#   - Changes to epicon/, docs/, or the catalog itself
#
# Author: Michael Judan
# License: MIT

name: Catalog Validation

on:
  push:
    branches: [main]
    paths:
      - 'epicon/**'
      - 'docs/**'
      - 'catalog/**'
      - 'scripts/exportCatalog.ts'
  pull_request:
    branches: [main]
    paths:
      - 'epicon/**'
      - 'docs/**'
      - 'catalog/**'
      - 'scripts/exportCatalog.ts'

jobs:
  validate-catalog:
    name: Validate Catalog Freshness
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Save current catalog hash
        id: before
        run: |
          if [ -f catalog/mobius_catalog.json ]; then
            HASH_BEFORE=$(sha256sum catalog/mobius_catalog.json | cut -d' ' -f1)
          else
            HASH_BEFORE="none"
          fi
          echo "hash=$HASH_BEFORE" >> $GITHUB_OUTPUT

      - name: Regenerate catalog
        run: npm run export:catalog
        env:
          GIT_COMMIT: ${{ github.sha }}

      - name: Check catalog hash after regeneration
        id: after
        run: |
          HASH_AFTER=$(sha256sum catalog/mobius_catalog.json | cut -d' ' -f1)
          echo "hash=$HASH_AFTER" >> $GITHUB_OUTPUT

      - name: Compare hashes
        run: |
          echo "Hash before: ${{ steps.before.outputs.hash }}"
          echo "Hash after:  ${{ steps.after.outputs.hash }}"
          
          if [ "${{ steps.before.outputs.hash }}" != "${{ steps.after.outputs.hash }}" ]; then
            echo ""
            echo "╔══════════════════════════════════════════════════════════════╗"
            echo "║  ⚠️  CATALOG IS STALE                                         ║"
            echo "╠══════════════════════════════════════════════════════════════╣"
            echo "║  The catalog/mobius_catalog.json file is out of date.        ║"
            echo "║                                                              ║"
            echo "║  Please run:                                                 ║"
            echo "║    npm run export:catalog                                    ║"
            echo "║                                                              ║"
            echo "║  Then commit the updated catalog:                            ║"
            echo "║    git add catalog/mobius_catalog.json                       ║"
            echo "║    git commit -m 'chore: update catalog'                     ║"
            echo "╚══════════════════════════════════════════════════════════════╝"
            echo ""
            exit 1
          fi
          
          echo ""
          echo "✅ Catalog is up-to-date!"

      - name: Validate catalog JSON
        run: |
          echo "Validating catalog JSON structure..."
          node -e "
            const fs = require('fs');
            const catalog = JSON.parse(fs.readFileSync('catalog/mobius_catalog.json', 'utf8'));
            
            // Basic validation
            if (!catalog.mobius_catalog_version) {
              throw new Error('Missing mobius_catalog_version');
            }
            if (!catalog.generated_at) {
              throw new Error('Missing generated_at');
            }
            if (!Array.isArray(catalog.epicons)) {
              throw new Error('epicons must be an array');
            }
            if (!Array.isArray(catalog.docs)) {
              throw new Error('docs must be an array');
            }
            
            console.log('Catalog version:', catalog.mobius_catalog_version);
            console.log('Generated at:', catalog.generated_at);
            console.log('EPICONs:', catalog.epicons.length);
            console.log('Docs:', catalog.docs.length);
            console.log('');
            console.log('✅ Catalog JSON is valid!');
          "

      - name: Summary
        if: always()
        run: |
          echo "## Catalog Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f catalog/mobius_catalog.json ]; then
            EPICON_COUNT=$(node -e "console.log(JSON.parse(require('fs').readFileSync('catalog/mobius_catalog.json')).epicons.length)")
            DOC_COUNT=$(node -e "console.log(JSON.parse(require('fs').readFileSync('catalog/mobius_catalog.json')).docs.length)")
            
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| EPICONs | $EPICON_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| Docs | $DOC_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*\"We heal as we walk.\" — Mobius Systems*" >> $GITHUB_STEP_SUMMARY

# MOBIUS-CLASS: security-secrets
# OWNER: @kaizencycle
# INTRODUCED: C-187
# LAST-REVIEWED: 2026-01-10
# STATUS: active
# PURPOSE: Scans for hardcoded secrets and credentials in code and commit history

name: Secret Scanning

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  schedule:
    - cron: '0 6 * * 1'  # Weekly Monday at 06:00 UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scanning

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}  # Optional for enterprise features
        continue-on-error: true  # Don't fail CI on first run, allow configuration

      - name: Upload Gitleaks results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gitleaks-results
          path: results.sarif
          retention-days: 30
          if-no-files-found: ignore

  trufflehog:
    name: TruffleHog Deep Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install TruffleHog
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

      - name: Run TruffleHog
        id: trufflehog
        run: |
          echo "ðŸ” Scanning repository for secrets..."
          
          # Scan the entire repository
          trufflehog git file://. --only-verified --json > trufflehog-results.json 2>&1 || true
          
          # Count findings
          FINDINGS=$(cat trufflehog-results.json | wc -l)
          echo "findings=$FINDINGS" >> $GITHUB_OUTPUT
          
          if [ "$FINDINGS" -gt 0 ]; then
            echo "âš ï¸ Found $FINDINGS potential secrets"
            cat trufflehog-results.json | head -50
          else
            echo "âœ… No verified secrets found"
          fi

      - name: Upload TruffleHog results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trufflehog-results
          path: trufflehog-results.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Comment on PR (if secrets found)
        if: github.event_name == 'pull_request' && steps.trufflehog.outputs.findings != '0'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const findings = '${{ steps.trufflehog.outputs.findings }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸš¨ Secret Scan Alert
              
              TruffleHog detected **${findings}** potential secret(s) in this PR.
              
              Please review the workflow artifacts for details and ensure no sensitive data is being committed.
              
              ### What to do:
              1. Check the TruffleHog results artifact
              2. Remove any hardcoded secrets
              3. Use environment variables or GitHub Secrets instead
              4. Consider rotating any exposed credentials
              
              ---
              *Automated by Mobius Secret Scanning (C-187)*`
            });

  file-scan:
    name: File Pattern Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Scan for sensitive file patterns
        id: filescan
        run: |
          echo "ðŸ” Scanning for sensitive file patterns..."
          
          ISSUES=""
          
          # Check for potential secret files
          SECRET_FILES=$(find . -type f \( \
            -name "*.pem" -o \
            -name "*.key" -o \
            -name "*.p12" -o \
            -name "*.pfx" -o \
            -name "*.jks" -o \
            -name "*credential*" -o \
            -name "*secret*" -o \
            -name ".env.local" -o \
            -name ".env.production" -o \
            -name "*.keystore" -o \
            -name "id_rsa" -o \
            -name "id_dsa" -o \
            -name "id_ecdsa" -o \
            -name "id_ed25519" \
          \) ! -path "./.git/*" ! -path "./node_modules/*" 2>/dev/null || true)
          
          if [ -n "$SECRET_FILES" ]; then
            echo "âš ï¸ Potentially sensitive files found:"
            echo "$SECRET_FILES"
            ISSUES="$ISSUES\n$SECRET_FILES"
          fi
          
          # Check for AWS credentials
          AWS_CREDS=$(grep -rn "AKIA[0-9A-Z]\{16\}" --include="*.ts" --include="*.js" --include="*.json" --include="*.yaml" --include="*.yml" . 2>/dev/null | grep -v node_modules || true)
          if [ -n "$AWS_CREDS" ]; then
            echo "âš ï¸ Potential AWS credentials found:"
            echo "$AWS_CREDS"
            ISSUES="$ISSUES\nAWS: $AWS_CREDS"
          fi
          
          # Check for hardcoded passwords
          PASSWORDS=$(grep -rn "password\s*[=:]\s*['\"][^'\"]\+" --include="*.ts" --include="*.js" --include="*.json" . 2>/dev/null | grep -v node_modules | grep -v "\.test\." | grep -v "example" | grep -v "placeholder" | head -10 || true)
          if [ -n "$PASSWORDS" ]; then
            echo "âš ï¸ Potential hardcoded passwords found:"
            echo "$PASSWORDS"
            ISSUES="$ISSUES\nPasswords: (check logs)"
          fi
          
          # Check for private keys in code
          PRIVATE_KEYS=$(grep -rn "-----BEGIN.*PRIVATE KEY-----" --include="*.ts" --include="*.js" --include="*.json" --include="*.md" . 2>/dev/null | grep -v node_modules || true)
          if [ -n "$PRIVATE_KEYS" ]; then
            echo "ðŸš¨ Private keys found in code!"
            echo "$PRIVATE_KEYS"
            ISSUES="$ISSUES\nPrivate Keys: $PRIVATE_KEYS"
          fi
          
          if [ -z "$ISSUES" ]; then
            echo "âœ… No sensitive file patterns detected"
            echo "status=clean" >> $GITHUB_OUTPUT
          else
            echo "status=issues" >> $GITHUB_OUTPUT
          fi

      - name: Report status
        run: |
          if [ "${{ steps.filescan.outputs.status }}" = "issues" ]; then
            echo "::warning::Sensitive file patterns detected. Review the logs above."
          else
            echo "âœ… File pattern scan passed"
          fi

  summary:
    name: Security Summary
    needs: [gitleaks, trufflehog, file-scan]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ›¡ï¸ Secret Scanning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Gitleaks | ${{ needs.gitleaks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TruffleHog | ${{ needs.trufflehog.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| File Patterns | ${{ needs.file-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Cycle: C-187 | Mobius Secret Scanning*" >> $GITHUB_STEP_SUMMARY

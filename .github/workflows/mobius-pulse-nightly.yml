name: Mobius Pulse Nightly

on:
  push:
    branches: [ main ]
  schedule:
    # 04:00 UTC every day (tweak as you like)
    - cron: "0 4 * * *"
  workflow_dispatch: {}

jobs:
  mobius-pulse:
    runs-on: ubuntu-latest
    continue-on-error: true  # Telemetry must not block PRs or main branch

    env:
      # You can keep these as defaults or override in the script
      MOBIUS_CYCLE: "C-UNSPECIFIED"
      # For now we use neutral baseline; replace later with real GI/MII pipeline
      GI_SCORE: "0.95"
      MII_SCORE: "0.95"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          if [ -f "package.json" ]; then
            npm ci || pnpm install || yarn install
          fi

      - name: Install cloc (for language stats)
        run: |
          sudo apt-get update
          sudo apt-get install -y cloc

      - name: Ensure pulse script is executable
        run: |
          if [ -f "scripts/mobius_pulse_json_v2.sh" ]; then
            chmod +x scripts/mobius_pulse_json_v2.sh
          else
            echo "scripts/mobius_pulse_json_v2.sh not found" >&2
            exit 1
          fi

      - name: Generate Mobius pulse JSON
        run: |
          GI_SCORE="${GI_SCORE}" MII_SCORE="${MII_SCORE}" MOBIUS_CYCLE="${MOBIUS_CYCLE}" \
            scripts/mobius_pulse_json_v2.sh > mobius-pulse.json

          echo "Generated mobius-pulse.json:"
          cat mobius-pulse.json | head -50

      - name: Post pulse to indexer
        env:
          INDEXER_BASE_URL: ${{ secrets.MOBIUS_INDEXER_BASE_URL }}
          PULSE_API_TOKEN: ${{ secrets.MOBIUS_PULSE_API_TOKEN }}
        run: |
          if [ -z "$INDEXER_BASE_URL" ]; then
            echo "❌ MOBIUS_INDEXER_BASE_URL not set in secrets" >&2
            echo "Skipping pulse ingestion (this is OK for local/dev)"
            exit 0
          fi

          URL="$INDEXER_BASE_URL/api/v1/pulse/ingest"

          echo "Posting pulse to $URL"

          if [ -n "$PULSE_API_TOKEN" ]; then
            AUTH_ARGS=(-H "Authorization: Bearer $PULSE_API_TOKEN")
          else
            AUTH_ARGS=()
          fi

          HTTP_CODE=$(curl -sS -o response.json -w "%{http_code}" \
            -X POST "$URL" \
            -H "Content-Type: application/json" \
            "${AUTH_ARGS[@]}" \
            --data-binary @mobius-pulse.json)

          echo "HTTP status: $HTTP_CODE"
          echo "Response:"
          cat response.json
          echo

          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "❌ Pulse ingest failed"
            exit 1
          fi

      - name: Short summary in logs
        run: |
          if [ -f "response.json" ]; then
            jq '{status, id, hash, cycle, giScore, miiScore, stats} // . ' response.json || true
          fi

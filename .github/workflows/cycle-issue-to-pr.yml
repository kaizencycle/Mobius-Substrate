name: Cycle Journal Issue -> PR

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  issue_to_pr:
    # Only run on Issues (not PR comments)
    # Only run when comment starts with /cycle update
    # Only run when Issue has the 'cycle-journal' label
    # Only run for allowed actors (kaizencycle, MobiusBot)
    if: >
      github.event.issue.pull_request == null &&
      startsWith(github.event.comment.body, '/cycle update ') &&
      contains(toJson(github.event.issue.labels), '"name":"cycle-journal"') &&
      (github.actor == 'kaizencycle' || github.actor == 'MobiusBot' || github.actor == 'github-actions[bot]')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Apply cycle command
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ACTOR: ${{ github.actor }}
          EXPECTED_NONCE: ${{ secrets.CYCLE_JOURNAL_NONCE }}
        run: node scripts/apply_cycle_command.mjs

      - name: Validate + Render
        run: npm run cycle:check

      - name: Create or update PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "cycle: apply issue command from #${{ github.event.issue.number }}"
          title: "cycle: update from issue #${{ github.event.issue.number }}"
          body: |
            ## Cycle Journal Update

            Auto-generated from issue comment command.

            - **Issue:** ${{ github.event.issue.html_url }}
            - **Actor:** ${{ github.actor }}
            - **Command:** See issue comment

            ## Changes

            This PR updates the Cycle Journal JSON based on the issue command:
            - Validated against `schemas/cycle_journal.schema.json`
            - Re-rendered markdown preview

            ## Validation Checklist

            - [ ] Schema validation passed
            - [ ] Evidence links are from trusted domains
            - [ ] No silent overwrites

            ---
            *Generated by Cycle Journal Issue → PR workflow*
            *"Memory holds. Motion continues."*
          branch: "bot/cycle-issue-${{ github.event.issue.number }}"
          base: "main"
          delete-branch: false

      - name: Add reaction to comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions" \
            -f content='rocket'

      - name: Comment on issue with PR link
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "## ✅ Cycle Journal Command Processed

          A PR has been created/updated with your changes.

          **Actor:** ${{ github.actor }}
          **Branch:** \`bot/cycle-issue-${{ github.event.issue.number }}\`

          Please review the PR for validation results.

          ---
          *Cycle Journal Bot*"

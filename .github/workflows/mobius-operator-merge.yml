name: mobius-operator-merge

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR to merge after consensus"
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  merge:
    runs-on: ubuntu-latest
    steps:
      - name: Check required statuses
        uses: actions/github-script@v7
        with:
          script: |
            const pr = parseInt(core.getInput('pr_number'));
            const { data: prData } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr
            });
            const sha = prData.head.sha;
            const { data: statuses } = await github.rest.repos.getCombinedStatusForRef({
              owner: context.repo.owner, repo: context.repo.repo, ref: sha
            });
            const required = ['mobius/consensus-gate','anti-nuke'];
            for (const r of required) {
              const ok = statuses.statuses.find(s => s.context === r && s.state === 'success');
              if (!ok) throw new Error(`Required status not green: ${r}`);
            }
            core.setOutput('sha', sha);

      - name: Merge PR
        uses: actions/github-script@v7
        with:
          script: |
            const pr = parseInt(core.getInput('pr_number'));
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr,
              merge_method: 'squash'
            });


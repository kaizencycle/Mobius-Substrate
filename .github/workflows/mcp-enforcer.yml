# MOBIUS-CLASS: core-integrity
# OWNER: @kaizencycle
# INTRODUCED: C-120 (updated C-148)
# LAST-REVIEWED: 2025-11-29
# STATUS: active
# MCP-VERSION: 1.0

name: MCP Enforcer (v1.0)

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, edited]

jobs:
  validate-cycle-protocol:
    name: Mobius Cycle Protocol Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Parse PR metadata
        id: parse
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Parsing PR for MCP v1.0 compliance..."
          
          # Extract cycle number from title or body
          CYCLE=$(echo "$PR_TITLE $PR_BODY" | grep -oP 'C-\d+' | head -1)
          
          if [ -z "$CYCLE" ]; then
            echo "cycle_found=false" >> $GITHUB_OUTPUT
          else
            echo "cycle_found=true" >> $GITHUB_OUTPUT
            echo "cycle=$CYCLE" >> $GITHUB_OUTPUT
            echo "âœ… Found cycle: $CYCLE"
          fi
      
      # ============================================
      # Phase 1: CYCLE_BEGIN Validation
      # ============================================
      
      - name: "MCP Phase 1: CYCLE_BEGIN"
        if: steps.parse.outputs.cycle_found == 'true'
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          CYCLE: ${{ steps.parse.outputs.cycle }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŒ€ MCP Phase 1: CYCLE_BEGIN"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Validating cycle initiation requirements..."
          echo "Cycle: $CYCLE"
          
          # Check for human intent declaration
          if ! echo "$PR_BODY" | grep -q "Human Intent\|Intent:"; then
            echo "âŒ Missing human intent declaration"
            echo "MCP v1.0 requires: Human Intent section in PR"
            exit 1
          fi
          echo "âœ… Human intent declared"
          
          # Check for baseline GI
          if echo "$PR_BODY" | grep -qE "Baseline.*GI|GI.*Baseline"; then
            echo "âœ… Baseline GI documented"
          else
            echo "âš ï¸  Baseline GI not explicitly stated (acceptable)"
          fi
      
      # ============================================
      # Phase 2: CYCLE_WORK Validation
      # ============================================
      
      - name: "MCP Phase 2: CYCLE_WORK"
        if: steps.parse.outputs.cycle_found == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš™ï¸  MCP Phase 2: CYCLE_WORK"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Validating work artifacts..."
          
          # Check for changed files
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD | wc -l)
          
          if [ "$CHANGED_FILES" -eq 0 ]; then
            echo "âŒ No files changed (empty PR)"
            exit 1
          fi
          
          echo "âœ… Files changed: $CHANGED_FILES"
          
          # Check for technical changes section
          if echo "$PR_BODY" | grep -q "Technical Changes"; then
            echo "âœ… Technical changes documented"
          else
            echo "âš ï¸  Technical changes section missing (should be present)"
          fi
      
      # ============================================
      # Phase 3: CYCLE_CLOSE Validation
      # ============================================
      
      - name: "MCP Phase 3: CYCLE_CLOSE"
        if: steps.parse.outputs.cycle_found == 'true'
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“‹ MCP Phase 3: CYCLE_CLOSE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Validating PR Bundle requirements..."
          
          # Required PR Bundle sections
          required_sections=(
            "Summary"
            "Human Intent"
            "Technical Changes"
            "Integrity Checks"
          )
          
          all_present=true
          
          for section in "${required_sections[@]}"; do
            if echo "$PR_BODY" | grep -qi "$section"; then
              echo "âœ… Section present: $section"
            else
              echo "âŒ Section missing: $section"
              all_present=false
            fi
          done
          
          if [ "$all_present" = false ]; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ PR Bundle incomplete"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "Required PR Bundle format:"
            echo ""
            echo "## Summary"
            echo "[Describe work completed]"
            echo ""
            echo "## Human Intent"
            echo "[State your intent at CYCLE_BEGIN]"
            echo ""
            echo "## Technical Changes"
            echo "- [List changes]"
            echo ""
            echo "## Integrity Checks"
            echo "- GI Score: 0.XX"
            echo "- Echo Score: 0.XX"
            echo ""
            exit 1
          fi
      
      # ============================================
      # GI Score Validation
      # ============================================
      
      - name: Validate GI Score
        if: steps.parse.outputs.cycle_found == 'true'
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Checking GI Score..."
          
          # Extract GI score
          GI=$(echo "$PR_BODY" | grep -oP 'GI Score:?\s*\K[0-9.]+' | head -1)
          
          if [ -z "$GI" ]; then
            echo "âŒ GI Score not found in PR description"
            echo "Required format: 'GI Score: 0.XX'"
            exit 1
          fi
          
          echo "Found GI Score: $GI"
          
          # Validate GI >= 0.95
          if (( $(echo "$GI < 0.95" | bc -l) )); then
            echo "âŒ GI Score below threshold ($GI < 0.95)"
            echo ""
            echo "To improve GI:"
            echo "  - Ensure architectural coherence"
            echo "  - Add comprehensive documentation"
            echo "  - Include tests for changes"
            echo "  - Review for integrity alignment"
            exit 1
          fi
          
          echo "âœ… GI Score acceptable: $GI â‰¥ 0.95"
      
      # ============================================
      # ECHO Score Validation
      # ============================================
      
      - name: Validate ECHO Score
        if: steps.parse.outputs.cycle_found == 'true'
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Checking ECHO Score..."
          
          # Extract ECHO score
          ECHO=$(echo "$PR_BODY" | grep -oP 'Echo Score:?\s*\K[0-9.]+' | head -1)
          
          if [ -z "$ECHO" ]; then
            echo "âŒ ECHO Score not found in PR description"
            echo "Required format: 'Echo Score: 0.XX'"
            exit 1
          fi
          
          echo "Found ECHO Score: $ECHO"
          
          # Validate ECHO >= 0.95
          if (( $(echo "$ECHO < 0.95" | bc -l) )); then
            echo "âŒ ECHO Score below threshold ($ECHO < 0.95)"
            echo ""
            echo "To improve ECHO Score:"
            echo "  - Fix drift from previous cycle"
            echo "  - Ensure semantic coherence"
            echo "  - Maintain consistency with Bio-DNA"
            echo "  - Review for reflection quality"
            exit 1
          fi
          
          echo "âœ… ECHO Score acceptable: $ECHO â‰¥ 0.95"
      
      # ============================================
      # Sentinel Validation
      # ============================================
      
      - name: Validate Sentinel Signatures
        if: steps.parse.outputs.cycle_found == 'true'
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ¤– Sentinel Validation"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Checking for tri-sentinel approval..."
          
          # Required sentinels for MCP v1.0
          required_sentinels=("ATLAS" "AUREA" "ECHO")
          
          all_approved=true
          
          for sentinel in "${required_sentinels[@]}"; do
            if echo "$PR_BODY" | grep -qi "$sentinel.*approve\|approve.*$sentinel\|âœ….*$sentinel"; then
              echo "âœ… $sentinel approved"
            else
              echo "âŒ $sentinel approval missing"
              all_approved=false
            fi
          done
          
          if [ "$all_approved" = false ]; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ Sentinel approval incomplete"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "MCP v1.0 requires ALL THREE sentinels:"
            echo "  - ATLAS (architectural coherence)"
            echo "  - AUREA (logical correctness)"
            echo "  - ECHO (drift analysis)"
            echo ""
            echo "Add to PR description:"
            echo "  âœ… ATLAS approved"
            echo "  âœ… AUREA approved"
            echo "  âœ… ECHO approved"
            exit 1
          fi
          
          echo ""
          echo "âœ… All sentinels approved (ATLAS, AUREA, ECHO)"
      
      # ============================================
      # MCP Compliance Summary
      # ============================================
      
      - name: MCP Compliance Summary
        if: steps.parse.outputs.cycle_found == 'true'
        env:
          CYCLE: ${{ steps.parse.outputs.cycle }}
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… MCP v1.0 VALIDATION PASSED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Cycle: $CYCLE"
          echo "Protocol: Mobius Cycle Protocol v1.0"
          echo ""
          echo "âœ… Phase 1: CYCLE_BEGIN (intent declared)"
          echo "âœ… Phase 2: CYCLE_WORK (changes present)"
          echo "âœ… Phase 3: CYCLE_CLOSE (PR bundle complete)"
          echo "âœ… GI Score â‰¥ 0.95"
          echo "âœ… ECHO Score â‰¥ 0.95"
          echo "âœ… Sentinel consensus achieved"
          echo ""
          echo "This PR is MCP-compliant and ready for Phase 4: CYCLE_ATTEST"
          echo ""
          echo "Next step: Merge â†’ Ledger attestation"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # ============================================
      # Handle Non-Cycle PRs
      # ============================================
      
      - name: Non-Cycle PR Warning
        if: steps.parse.outputs.cycle_found == 'false'
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  NON-CYCLE PR DETECTED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "This PR does not include a cycle number (C-XXX)."
          echo ""
          echo "For hotfixes and emergency patches, this is acceptable."
          echo "However, all regular work should follow MCP v1.0."
          echo ""
          echo "To make this MCP-compliant:"
          echo "  1. Add cycle number to PR title or description (e.g., C-148)"
          echo "  2. Include Human Intent section"
          echo "  3. Add GI Score and ECHO Score"
          echo "  4. Document sentinel approvals"
          echo ""
          echo "âš ï¸  This check will PASS but the PR is not tracked in ledger"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

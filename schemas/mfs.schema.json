{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mobius.systems/schemas/mfs.schema.json",
  "title": "Mobius Fractal Shard",
  "description": "Schema for Mobius Fractal Shards (MFS) - atomic units of integrity in Mobius Systems",
  "type": "object",
  "required": [
    "mfs_id",
    "citizen_id",
    "archetype",
    "weight",
    "quality_score",
    "timestamp",
    "integrity_coefficient",
    "computed_mii_delta",
    "signature",
    "provenance"
  ],
  "properties": {
    "mfs_id": {
      "type": "string",
      "description": "Unique identifier for the MFS",
      "pattern": "^MFS-[0-9]{4}-[0-9]{2}-[0-9]{2}-[0-9]{6}$",
      "examples": ["MFS-2025-12-05-000187"]
    },
    "citizen_id": {
      "type": "string",
      "description": "Identifier of the citizen or agent who earned the shard",
      "pattern": "^(CIT|AGT)-0x[a-fA-F0-9]+$",
      "examples": ["CIT-0x92fA1234567890abcdef"]
    },
    "archetype": {
      "type": "string",
      "description": "One of the seven fractal archetypes",
      "enum": ["REF", "LRN", "CIV", "STB", "STW", "INV", "GRD"]
    },
    "weight": {
      "type": "number",
      "description": "Archetype weight (0-1, must sum to 1.0 across all archetypes)",
      "minimum": 0,
      "maximum": 1,
      "examples": [0.25, 0.20, 0.15]
    },
    "quality_score": {
      "type": "number",
      "description": "Quality multiplier assessed by Sentinels (0.5-2.0)",
      "minimum": 0.5,
      "maximum": 2.0,
      "default": 1.0
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of when the shard was created"
    },
    "integrity_coefficient": {
      "type": "number",
      "description": "Epoch-specific coefficient for MII calculation",
      "minimum": 0,
      "examples": [0.0000021]
    },
    "computed_mii_delta": {
      "type": "number",
      "description": "This shard's contribution to ΔMII (weight × quality_score × integrity_coefficient)",
      "examples": [0.000000735]
    },
    "metadata": {
      "type": "object",
      "description": "Optional metadata about the action that earned this shard",
      "properties": {
        "source": {
          "type": "string",
          "description": "Application or service that generated this shard",
          "examples": ["reflections_app", "civic_hub", "learning_portal"]
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of the action"
        },
        "geo_hint": {
          "type": "string",
          "description": "Optional geographic hint (city, region)",
          "examples": ["NYC-10027", "SF-94102"]
        },
        "action_id": {
          "type": "string",
          "description": "Reference to the original action/event"
        },
        "tags": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Optional tags for categorization"
        }
      },
      "additionalProperties": true
    },
    "signature": {
      "type": "string",
      "description": "Ed25519 signature from the issuing Sentinel",
      "pattern": "^ed25519:0x[a-fA-F0-9]+$"
    },
    "provenance": {
      "type": "object",
      "description": "Attestation and provenance information",
      "required": ["sentinel_attestors", "merkle_root"],
      "properties": {
        "sentinel_attestors": {
          "type": "array",
          "description": "List of Sentinels that attested to this shard",
          "items": {
            "type": "string",
            "enum": ["atlas", "aurea", "eve", "jade", "zeus", "hermes", "echo"]
          },
          "minItems": 1
        },
        "merkle_root": {
          "type": "string",
          "description": "Merkle root for aggregation verification",
          "pattern": "^0x[a-fA-F0-9]{64}$"
        },
        "ledger_event_id": {
          "type": "string",
          "description": "Reference to the ledger event",
          "pattern": "^LED-[0-9]{4}-[0-9]{2}-[0-9]{2}-[0-9]{5}$"
        },
        "block_height": {
          "type": "integer",
          "description": "Block height when recorded (if on-chain)"
        }
      }
    }
  },
  "additionalProperties": false,
  
  "definitions": {
    "FractalState": {
      "type": "object",
      "description": "Aggregated fractal state for a citizen",
      "properties": {
        "citizen_id": { "type": "string" },
        "total_mfs": { "type": "integer" },
        "weighted_sum": { "type": "number" },
        "by_archetype": {
          "type": "object",
          "properties": {
            "REF": { "type": "integer" },
            "LRN": { "type": "integer" },
            "CIV": { "type": "integer" },
            "STB": { "type": "integer" },
            "STW": { "type": "integer" },
            "INV": { "type": "integer" },
            "GRD": { "type": "integer" }
          }
        },
        "delta_mii_contribution": { "type": "number" },
        "last_updated": { "type": "string", "format": "date-time" }
      }
    },
    
    "MfsSubmission": {
      "type": "object",
      "description": "Payload for submitting a new MFS candidate",
      "required": ["citizen_id", "archetype"],
      "properties": {
        "citizen_id": { "type": "string" },
        "archetype": {
          "type": "string",
          "enum": ["REF", "LRN", "CIV", "STB", "STW", "INV", "GRD"]
        },
        "quality_score": {
          "type": "number",
          "minimum": 0.5,
          "maximum": 2.0
        },
        "metadata": { "type": "object" }
      }
    }
  }
}

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Mobius Thought Broker â€” KTT Trial-001 Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #050816;
        color: #e5e7eb;
      }

      body {
        margin: 0;
        padding: 0;
      }

      .page {
        max-width: 1120px;
        margin: 0 auto;
        padding: 1.5rem;
      }

      h1,
      h2,
      h3 {
        margin: 0 0 0.5rem;
      }

      .subtle {
        font-size: 0.85rem;
        color: #9ca3af;
      }

      .card {
        background: #0b1020;
        border-radius: 0.75rem;
        padding: 1rem 1.25rem;
        border: 1px solid #1f2937;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
      }

      .grid {
        display: grid;
        grid-template-columns: 1.5fr 2fr;
        gap: 1rem;
      }

      .grid-3 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 0.75rem;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.15rem 0.55rem;
        border-radius: 999px;
        font-size: 0.75rem;
        border: 1px solid #374151;
        background: radial-gradient(circle at top, #111827, #020617);
      }

      .pill-green {
        border-color: #16a34a;
        color: #bbf7d0;
      }

      .pill-amber {
        border-color: #f59e0b;
        color: #fed7aa;
      }

      .pill-red {
        border-color: #ef4444;
        color: #fecaca;
      }

      .label {
        font-size: 0.75rem;
        color: #9ca3af;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .value {
        font-size: 1.1rem;
        font-weight: 600;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
      }

      th,
      td {
        padding: 0.4rem 0.5rem;
        border-bottom: 1px solid #111827;
      }

      th {
        text-align: left;
        font-weight: 500;
        color: #9ca3af;
        position: sticky;
        top: 0;
        background: #050816;
      }

      tr {
        cursor: pointer;
      }

      tr:hover {
        background: rgba(37, 99, 235, 0.15);
      }

      tr.active-row {
        background: rgba(129, 140, 248, 0.25);
      }

      .muted {
        color: #6b7280;
      }

      .flex {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .flex-between {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
      }

      .tag {
        display: inline-flex;
        padding: 0.1rem 0.45rem;
        border-radius: 999px;
        border: 1px solid #374151;
        font-size: 0.7rem;
        color: #9ca3af;
        margin-right: 0.25rem;
        margin-bottom: 0.25rem;
      }

      button {
        border-radius: 999px;
        border: 1px solid #2563eb;
        background: #1d4ed8;
        color: #e5e7eb;
        font-size: 0.8rem;
        padding: 0.3rem 0.75rem;
        cursor: pointer;
      }

      button.secondary {
        border-color: #374151;
        background: transparent;
      }

      button:disabled {
        opacity: 0.5;
        cursor: default;
      }

      input[type='text'] {
        background: #020617;
        border-radius: 999px;
        border: 1px solid #1f2937;
        color: #e5e7eb;
        padding: 0.3rem 0.75rem;
        font-size: 0.8rem;
        width: 100%;
        max-width: 260px;
      }

      code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono',
          'Courier New', monospace;
        font-size: 0.8rem;
        background: #020617;
        padding: 0.1rem 0.25rem;
        border-radius: 0.25rem;
      }

      .scroll {
        max-height: 360px;
        overflow: auto;
      }

      @media (max-width: 800px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="flex-between" style="margin-bottom: 1rem;">
        <div>
          <h1>Mobius Thought Broker</h1>
          <div class="subtle">
            KTT Trial-001 â€¢ Dispatch-style ethical paths â€¢ Live in-broker observability
          </div>
        </div>
        <div class="pill pill-green">
          <span>ðŸ§ª Trial-001</span>
          <span class="muted">Dashboard</span>
        </div>
      </div>

      <div class="card" style="margin-bottom: 1rem;">
        <div class="flex-between">
          <div>
            <div class="label">Broker base URL</div>
            <input id="baseUrlInput" type="text" />
            <div class="subtle" style="margin-top: 0.25rem;">
              Defaults to <code>window.location.origin</code>. Change if dashboard is proxied.
            </div>
          </div>
          <div>
            <button id="refreshButton">ðŸ”„ Refresh</button>
          </div>
        </div>
      </div>

      <div class="grid" style="margin-bottom: 1rem;">
        <div class="card">
          <div class="flex-between" style="margin-bottom: 0.75rem;">
            <h2>Global Stats</h2>
            <span id="globalStatusPill" class="pill pill-amber">Awaiting dataâ€¦</span>
          </div>
          <div class="grid-3">
            <div>
              <div class="label">Total Trials</div>
              <div class="value" id="totalTrialsValue">â€”</div>
            </div>
            <div>
              <div class="label">Active</div>
              <div class="value" id="activeTrialsValue">â€”</div>
            </div>
            <div>
              <div class="label">Completed</div>
              <div class="value" id="completedTrialsValue">â€”</div>
            </div>
            <div>
              <div class="label">Aborted</div>
              <div class="value" id="abortedTrialsValue">â€”</div>
            </div>
            <div>
              <div class="label">Timeout</div>
              <div class="value" id="timeoutTrialsValue">â€”</div>
            </div>
            <div>
              <div class="label">Avg Alignment</div>
              <div class="value" id="avgAlignmentValue">â€”</div>
            </div>
            <div>
              <div class="label">Avg GI</div>
              <div class="value" id="avgGiValue">â€”</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="flex-between" style="margin-bottom: 0.5rem;">
            <div>
              <h2>Trials</h2>
              <div class="subtle">
                Click a row to view summary + event trail.
              </div>
            </div>
            <div class="flex">
              <input id="trialIdInput" type="text" placeholder="Jump to trialIdâ€¦" />
              <button id="jumpButton" class="secondary">Go</button>
            </div>
          </div>
          <div class="scroll">
            <table>
              <thead>
                <tr>
                  <th>Trial</th>
                  <th>Participant</th>
                  <th>Scenario</th>
                  <th>Status</th>
                  <th>Steps</th>
                  <th>Avg Align</th>
                  <th>Avg GI</th>
                </tr>
              </thead>
              <tbody id="trialsTableBody">
                <tr>
                  <td colspan="7" class="muted">No data yet. Run a trial, then refresh.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="flex-between" style="margin-bottom: 0.5rem;">
          <div>
            <h2>Trial Detail</h2>
            <div class="subtle" id="currentTrialLabel">No trial selected.</div>
          </div>
        </div>

        <div class="grid">
          <div>
            <div class="label">Summary</div>
            <div id="summaryBlock" class="subtle" style="margin-top: 0.25rem;">
              Select a trial from the table to view its summary.
            </div>
          </div>
          <div>
            <div class="label">Events</div>
            <div id="eventsBlock" class="subtle scroll" style="margin-top: 0.25rem; max-height: 260px;">
              No events yet.
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const baseUrlInput = document.getElementById('baseUrlInput');
        const refreshButton = document.getElementById('refreshButton');
        const trialsTableBody = document.getElementById('trialsTableBody');
        const globalStatusPill = document.getElementById('globalStatusPill');

        const totalTrialsValue = document.getElementById('totalTrialsValue');
        const activeTrialsValue = document.getElementById('activeTrialsValue');
        const completedTrialsValue = document.getElementById('completedTrialsValue');
        const abortedTrialsValue = document.getElementById('abortedTrialsValue');
        const timeoutTrialsValue = document.getElementById('timeoutTrialsValue');
        const avgAlignmentValue = document.getElementById('avgAlignmentValue');
        const avgGiValue = document.getElementById('avgGiValue');

        const trialIdInput = document.getElementById('trialIdInput');
        const jumpButton = document.getElementById('jumpButton');

        const currentTrialLabel = document.getElementById('currentTrialLabel');
        const summaryBlock = document.getElementById('summaryBlock');
        const eventsBlock = document.getElementById('eventsBlock');

        let currentTrials = [];
        let activeTrialId = null;

        baseUrlInput.value = window.location.origin;

        function getBaseUrl() {
          const v = baseUrlInput.value.trim();
          return v || window.location.origin;
        }

        function formatScore(x) {
          if (typeof x !== 'number' || isNaN(x)) return 'â€”';
          return x.toFixed(3);
        }

        function setGlobalStatus(label, variant) {
          globalStatusPill.textContent = label;
          globalStatusPill.className = 'pill ' + (variant || 'pill-amber');
        }

        async function fetchJson(path) {
          const base = getBaseUrl().replace(/\/+$/, '');
          const url = base + path;
          const res = await fetch(url);
          if (!res.ok) {
            throw new Error('Request failed: ' + res.status + ' ' + (await res.text()));
          }
          return res.json();
        }

        async function loadGlobal() {
          setGlobalStatus('Loadingâ€¦', 'pill-amber');
          try {
            const stats = await fetchJson('/v1/trials/ktt-001/stats');
            const list = await fetchJson('/v1/trials/ktt-001');

            currentTrials = Array.isArray(list.trials) ? list.trials : [];

            // Stats
            totalTrialsValue.textContent = stats.totalTrials ?? 0;
            activeTrialsValue.textContent = stats.activeTrials ?? 0;
            completedTrialsValue.textContent = stats.completedTrials ?? 0;
            abortedTrialsValue.textContent = stats.abortedTrials ?? 0;
            timeoutTrialsValue.textContent = stats.timeoutTrials ?? 0;
            avgAlignmentValue.textContent = formatScore(stats.avgAlignmentScore);
            avgGiValue.textContent = formatScore(stats.avgGiSnapshot);

            if (stats.totalTrials > 0) {
              setGlobalStatus('Online â€¢ Trials observed', 'pill-green');
            } else {
              setGlobalStatus('Online â€¢ No trials yet', 'pill-amber');
            }

            renderTrialsTable();
          } catch (err) {
            console.error(err);
            setGlobalStatus('Error loading data', 'pill-red');
            totalTrialsValue.textContent = 'â€”';
            activeTrialsValue.textContent = 'â€”';
            completedTrialsValue.textContent = 'â€”';
            abortedTrialsValue.textContent = 'â€”';
            timeoutTrialsValue.textContent = 'â€”';
            avgAlignmentValue.textContent = 'â€”';
            avgGiValue.textContent = 'â€”';

            trialsTableBody.innerHTML =
              '<tr><td colspan="7" class="muted">Failed to load from broker. Check URL and network.</td></tr>';
          }
        }

        function renderTrialsTable() {
          if (!currentTrials.length) {
            trialsTableBody.innerHTML =
              '<tr><td colspan="7" class="muted">No trials yet. Run a KTT Trial-001 session and refresh.</td></tr>';
            return;
          }

          const rows = currentTrials
            .sort((a, b) => (a.createdAt || '').localeCompare(b.createdAt || ''))
            .map((t) => {
              const statusLabel = t.status === 'active' ? 'Active' : 'Closed';
              const completion = t.completionStatus || '';
              const statusText = completion ? statusLabel + ' â€¢ ' + completion : statusLabel;

              const isActive = activeTrialId && activeTrialId === t.trialId;

              return `
              <tr data-trial-id="${t.trialId}" class="${
                isActive ? 'active-row' : ''
              }">
                <td><code>${t.trialId}</code></td>
                <td>${t.participantId || '<span class="muted">anonymous</span>'}</td>
                <td>${t.scenarioId || '<span class="muted">â€”</span>'}</td>
                <td>${statusText}</td>
                <td>${typeof t.steps === 'number' ? t.steps : 'â€”'}</td>
                <td>${formatScore(t.avgAlignmentScore)}</td>
                <td>${formatScore(t.avgGiSnapshot)}</td>
              </tr>
            `;
            })
            .join('');

          trialsTableBody.innerHTML = rows;

          Array.from(trialsTableBody.querySelectorAll('tr[data-trial-id]')).forEach((row) => {
            row.addEventListener('click', () => {
              const id = row.getAttribute('data-trial-id');
              if (id) {
                selectTrial(id);
              }
            });
          });
        }

        async function selectTrial(trialId) {
          activeTrialId = trialId;

          // update selected row styling
          Array.from(trialsTableBody.querySelectorAll('tr[data-trial-id]')).forEach((row) => {
            const id = row.getAttribute('data-trial-id');
            if (id === trialId) row.classList.add('active-row');
            else row.classList.remove('active-row');
          });

          currentTrialLabel.innerHTML = 'Selected trial: <code>' + trialId + '</code>';
          summaryBlock.textContent = 'Loadingâ€¦';
          eventsBlock.textContent = 'Loadingâ€¦';

          try {
            const [summary, events] = await Promise.all([
              fetchJson('/v1/trials/ktt-001/' + encodeURIComponent(trialId) + '/summary'),
              fetchJson('/v1/trials/ktt-001/' + encodeURIComponent(trialId) + '/events'),
            ]);

            renderSummary(summary);
            renderEvents(events.events || []);
          } catch (err) {
            console.error(err);
            summaryBlock.innerHTML =
              '<span class="muted">Failed to load trial summary. Check logs.</span>';
            eventsBlock.innerHTML =
              '<span class="muted">Failed to load trial events. Check logs.</span>';
          }
        }

        function renderSummary(s) {
          if (!s) {
            summaryBlock.innerHTML =
              '<span class="muted">Trial not found in this broker instance.</span>';
            return;
          }

          summaryBlock.innerHTML = `
            <div style="margin-bottom: 0.5rem;">
              <div><span class="label">Trial ID</span> <code>${s.trialId}</code></div>
              <div><span class="label">Participant</span> ${
                s.participantId || '<span class="muted">anonymous</span>'
              }</div>
              <div><span class="label">Scenario</span> ${
                s.scenarioId || '<span class="muted">â€”</span>'
              }</div>
            </div>
            <div style="margin-bottom: 0.5rem;">
              <div><span class="label">Status</span> ${
                s.status === 'active' ? 'Active' : 'Closed'
              } ${s.completionStatus ? 'â€¢ ' + s.completionStatus : ''}</div>
              <div><span class="label">Steps</span> ${typeof s.steps === 'number' ? s.steps : 'â€”'}</div>
            </div>
            <div style="margin-bottom: 0.5rem;">
              <div><span class="label">Avg Alignment</span> ${formatScore(s.avgAlignmentScore)}</div>
              <div><span class="label">Avg GI</span> ${formatScore(s.avgGiSnapshot)}</div>
            </div>
            <div id="micBlock" style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #111827;">
              <div class="label">MIC Reward (simulated)</div>
              <div class="muted">Loading MIC suggestionâ€¦</div>
            </div>
            <div class="muted" style="margin-top: 0.5rem;">
              <div><span class="label">Created</span> ${s.createdAt || 'â€”'}</div>
              <div><span class="label">Closed</span> ${s.closedAt || 'â€”'}</div>
            </div>
          `;

          attachMicSuggestion(s.trialId);
        }

        function renderEvents(events) {
          if (!events || !events.length) {
            eventsBlock.innerHTML =
              '<span class="muted">No events recorded for this trial.</span>';
            return;
          }

          const content = events
            .sort((a, b) => (a.stepIndex || 0) - (b.stepIndex || 0))
            .map((e) => {
              const tags = Array.isArray(e.tags)
                ? e.tags.map((t) => '<span class="tag">' + t + '</span>').join('')
                : '';

              return `
              <div style="margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid #111827;">
                <div class="flex-between">
                  <div>
                    <strong>Step ${e.stepIndex}</strong>
                    <div class="muted">${e.createdAt || ''}</div>
                  </div>
                  <div>
                    <span class="label">Align</span> ${formatScore(e.alignmentScore)}<br/>
                    <span class="label">GI</span> ${formatScore(e.giSnapshot)}
                  </div>
                </div>
                <div style="margin-top: 0.25rem;">
                  <div class="label">Prompt</div>
                  <div>${e.prompt || '<span class="muted">â€”</span>'}</div>
                </div>
                <div style="margin-top: 0.25rem;">
                  <div class="label">User Choice</div>
                  <div>${e.userChoice || '<span class="muted">â€”</span>'}</div>
                </div>
                <div style="margin-top: 0.25rem;">
                  <div class="label">Model Choice</div>
                  <div>${e.modelChoice || '<span class="muted">â€”</span>'}</div>
                </div>
                ${
                  tags
                    ? `<div style="margin-top: 0.25rem;">
                         <div class="label">Tags</div>
                         <div>${tags}</div>
                       </div>`
                    : ''
                }
              </div>
            `;
            })
            .join('');

          eventsBlock.innerHTML = content;
        }

        async function attachMicSuggestion(trialId) {
          const micBlock = document.getElementById('micBlock');
          if (!micBlock) {
            return;
          }

          micBlock.innerHTML = `
            <div class="label">MIC Reward (simulated)</div>
            <div class="muted">Loading MIC suggestionâ€¦</div>
          `;

          try {
            const data = await fetchJson(
              '/v1/trials/ktt-001/' + encodeURIComponent(trialId) + '/mic-suggestion',
            );

            const suggested =
              typeof data.suggestedMic === 'number' ? data.suggestedMic.toFixed(2) : '0.00';
            const max = typeof data.maxMic === 'number' ? data.maxMic.toFixed(2) : '0.00';
            const intensity = data.rewardIntensity || 'none';
            const note = data.note || '';

            micBlock.innerHTML = `
              <div class="label">MIC Reward (simulated)</div>
              <div style="margin-top: 0.25rem;">
                <span class="value">${suggested}</span>
                <span class="muted">/ ${max} MIC</span>
              </div>
              <div class="muted" style="margin-top: 0.25rem;">
                Intensity: <code>${intensity}</code>${
              data.reason ? ' â€¢ Reason: <code>' + data.reason + '</code>' : ''
            }
              </div>
              ${
                note
                  ? '<div class="muted" style="margin-top: 0.25rem;">' +
                    note.replace(/</g, '&lt;').replace(/>/g, '&gt;') +
                    '</div>'
                  : ''
              }
              <div class="muted" style="margin-top: 0.25rem; font-size: 0.75rem;">
                This is a simulation only. No MIC is actually minted by the broker.
              </div>
            `;
          } catch (err) {
            console.error(err);
            micBlock.innerHTML = `
              <div class="label">MIC Reward (simulated)</div>
              <div class="muted">Failed to load MIC suggestion. Check broker logs.</div>
            `;
          }
        }

        refreshButton.addEventListener('click', () => {
          loadGlobal();
        });

        jumpButton.addEventListener('click', () => {
          const id = (trialIdInput.value || '').trim();
          if (!id) return;
          selectTrial(id);
        });

        // Initial load
        loadGlobal();
      })();
    </script>
  </body>
</html>

